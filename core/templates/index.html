{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset=" utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- Bulma -->
    <link rel="stylesheet" type="text/css" href="{% static 'core/bulma/css/bulma.min.css' %}">

    <!-- chart.js -->
    <script src="{% static 'core/chartjs/package/dist/chart.js' %}"></script>
    <script src="{% static 'core/chartjs-plugin-annotation.js' %}"></script>

    <!-- speedo chart -->
    <script src="{% static 'core/gauge.js' %}"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" type="text/css" href="{% static 'core/core.css' %}">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="{% static 'core/fafa/css/all.css' %}">

    <!-- Mapbox Stuff -->
    <script src="{% static 'core/maplibre-gl.js' %}"></script>
    <link href="{% static 'core/maplibre-gl.css' %}" rel='stylesheet' />
    <script src="{% static 'core/map-gl-utils.js' %}"></script>
    <title>BoatBuddy</title>
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'core/favicon.ico' %}">

</head>


<!-- Data Update Script-->
<script>
    let coupled = true;
    let route = true;
    let knots = true;
    let socket = new WebSocket('ws://boatbuddy.live/ws/data/');
    socket.onopen = function (e) {
        console.log('Connection established');

    };

    let track_history;
    fetch("{% static 'core/track_history.json' %}").then(
        function (u) { return u.json(); }
    ).then(
        function (json) {
            track_history = json;
        }
    );




    socket.onmessage = function (e) {
        console.log(e.data);
        var recData = JSON.parse(e.data);

        var mph = recData.mph;
        var knts = recData.knts;
        var kph = recData.kph;
        var direction = recData.direction;
        var heading = recData.heading;
        var depth = recData.depth;
        var tide_type = recData.tide_type;
        var tide_time = recData.tide_time;
        var times = recData.times;
        var heights = recData.heights;
        var lat = recData.lat;
        var lon = recData.lon;
        var track = recData.track;
        document.getElementById("speed").innerHTML = "";
        if (knots){
            document.getElementById("speed").innerHTML = Math.floor(knts);
            configSpeed.data.current = knts;
        } else {
            document.getElementById("speed").innerHTML = Math.floor(mph);
            configSpeed.data.current = mph;
        };
        document.getElementById("direction").innerHTML = direction;
        document.getElementById("heading").innerHTML = heading;
        document.getElementById("tide_type").innerHTML = tide_type;
        document.getElementById("tide_time").innerHTML = tide_time;
        document.getElementById("speednavvalue").innerHTML = Math.floor(speed);
        document.getElementById("dirarrow").style.transform = "rotate(" + heading + "deg)";


        
        window.speed.update();


        tidedata['data']["labels"] = times;
        tidedata['data']['datasets'][0]['data'] = heights;
        tidedata['options']['annotation']['annotations'][0]["value"] = tide_time;
        window.linechart.update();

        new maplibregl.Marker(current).setLngLat([lon, lat]).addTo(map);

        if (coupled === true) {
            map.setBearing(heading);
            map.panTo([lon, lat]);
        };

        track_history.features[0].geometry.coordinates = track;
        map.getSource("track_history").setData(track_history);


    };

    socket.onclose = function (e) {
        alert('Connection Closed');
    };

</script>




<body class="has-background-dark">

    <div class="container">
        <i class="power btn btn-sm fas fa-power-off has-text-danger" id="power"></i>
        <div class="columns is-mobile is-gapless mb-0 z1 is-full">

            <div class="column is-narrow">
                <div id="tide" class="">
                    <span><i class="fas fa-arrows-alt-v has-text-link is-size-3 ml-2"></i></span>
                    <span id="tide_type" class="is-size-3 has-text-weight-bold has-text-light pl-2">H</span>
                    <span id="tide_time" class="is-size-3 has-text-weight-bold has-text-light pl-2"> 06:53</span>
                </div>
                <div id="speednav" class="" style="display: none;">
                    <span><i class="fas fa-tachometer-alt has-text-primary ml-2 is-size-3"></i></span>
                    <span class="is-size-3 has-text-weight-bold has-text-light" id="speednavvalue"
                        style="font-family:Orbitron">23</span>
                </div>
            </div>

            <div class="column has-text-centered is-centered">

            </div>



            <div class="column has-text-right is-narrow is-right righthand">
                <div id="dirnav" class="">
                    <span><i id="dirarrow" class="fas fa-long-arrow-alt-up has-text-danger is-size-3 mr-2"></i></span>
                    <span class="is-size-3 has-text-weight-bold has-text-light" id="heading">110</span><span id="degree"
                        class="has-text-light has-text-weight-bold is-size-3">Â° </span>
                    <span class="is-size-3 has-text-weight-bold has-text-light mr-2" id="direction">N</span>
                    <span><i class="far fa-compass has-text-info mr-2 is-size-3"></i></span>
                </div>
            </div>
        </div>

        <div id="canvas-holder" class="overlaid" name="speedchart">
            <div class="mph" id="speed">
                0
            </div>
            <canvas id="chart-speed" class=""></canvas>
            <i class="power btn btn-sm fas fa-power-off has-text-danger z3" id="power"></i>
        </div>

        <div id="canvas-holder" class="overlaid-tide has-text-centered" name="tidechart" style="display:none;">
            <canvas id="chart-tide" class="mb-0 py-6"></canvas>
        </div>

        <div id="map-holder" class="" name="mapboxdiv" style="display:none;">


            <div id='map' class="has-background-dark" name="mapboxdiv"></div>
            <i id="lock" class="fas fa-lock has-text-grey lock is-size-3"></i>
            <i id="unlock" class="fas fa-unlock has-text-success lock is-size-3" style="display:none;"></i>
            <i id="route" class="fas fa-route route is-size-3" style="color:red"></i>

            <script>


                var map = new maplibregl.Map({
                    container: 'map',
                    style: "{% static 'core/style/style.json' %}",
                    center: [-74.570980, 39.287440],
                    setView: [-74.570980, 39.287440],
                    zoom: 14,
                    minZoom: 8,
                    bearing: 60,
                    pitch: 60
                });

                map.on("load", function () {
                    map.addSource("deptharea", {
                        "type": 'geojson',

                        "data": "{% static 'core/US5NJ20M/DEPARE.geojson' %}"
                    });
                    map.addSource("sounding", {
                        "type": 'geojson',

                        "data": "{% static 'core/US5NJ20M/SOUNDG.json' %}"

                    });
                    map.addSource("deptharea2", {
                        "type": 'geojson',

                        "data": "{% static 'core/US5NJ24M/DEPARE.geojson' %}"
                    });
                    map.addSource("sounding2", {
                        "type": 'geojson',

                        "data": "{% static 'core/US5NJ24M/SOUNDG.json' %}"

                    });
                    map.addSource("rectrack", {
                        "type": 'geojson',

                        "data": "{% static 'core/US5NJ20M/RECTRC.geojson' %}"
                    });
                    map.addSource("rectrack2", {
                        "type": 'geojson',

                        "data": "{% static 'core/US5NJ24M/RECTRC.geojson' %}"
                    });
                    map.addSource("deptharea3", {
                        "type": 'geojson',

                        "data": "{% static 'core/US5NJ25M/DEPARE.geojson' %}"
                    });
                    map.addSource("sounding3", {
                        "type": 'geojson',

                        "data": "{% static 'core/US5NJ25M/SOUNDG.json' %}"

                    });
                    map.addSource("track_history", {
                        "type": 'geojson',

                        "data": "{% static 'core/track_history.json' %}"
                    });
                    map.loadImage("{% static 'core/beacon1.png' %}", (error, image1) => {
                        if (error) throw error;
                        map.addImage('beacon-1', image1, { 'sdf': true });
                    });
                    map.addSource("beacon_1", {
                        "type": 'geojson',

                        "data": "{% static 'core/T1BEACON.json' %}"
                    });

                    map.loadImage("{% static 'core/beacon2.png' %}", (error, image2) => {
                        if (error) throw error;
                        map.addImage('beacon-2', image2, { 'sdf': true });
                    });
                    map.addSource("beacon_2", {
                        "type": 'geojson',

                        "data": "{% static 'core/T2BEACON.json' %}"
                    });

                    map.loadImage("{% static 'core/buoy1.png' %}", (error, image3) => {
                        if (error) throw error;
                        map.addImage('buoy-1', image3, { 'sdf': true });
                    });
                    map.addSource("buoy_1", {
                        "type": 'geojson',

                        "data": "{% static 'core/T1BUOY.json' %}"
                    });

                    map.loadImage("{% static 'core/buoy2.png' %}", (error, image4) => {
                        if (error) throw error;
                        map.addImage('buoy-2', image4, { 'sdf': true });
                    });

                    map.addSource("buoy_2", {
                        "type": 'geojson',

                        "data": "{% static 'core/T2BUOY.json' %}"
                    });




                    map.addLayer({
                        'id': 'track_history',
                        'type': 'line',
                        'source': 'track_history',
                        "paint": {
                            "line-color": "#ff0000",
                            'line-width': 3
                        }
                    });
                    map.addLayer({
                        'id': 'deptharea',
                        'type': 'line',
                        'source': 'deptharea',
                    });

                    map.addLayer({
                        'id': 'sounding',
                        'type': 'symbol',
                        'source': 'sounding',
                        layout: {
                            'text-field': "{depth}",
                            'text-font': ["Open Sans Regular"]
                        }
                    });
                    map.addLayer({
                        'id': 'deptharea2',
                        'type': 'line',
                        'source': 'deptharea2',
                    });

                    map.addLayer({
                        'id': 'sounding2',
                        'type': 'symbol',
                        'source': 'sounding2',
                        layout: {
                            'text-field': "{depth}",
                            'text-font': ["Open Sans Regular"]
                        }
                    });
                    map.addLayer({
                        'id': 'rectrack',
                        'type': 'line',
                        'source': 'rectrack',
                        "paint": {
                            "line-color": "#fbff12",
                            'line-width': 3
                        }
                    });

                    map.addLayer({
                        'id': 'rectrack2',
                        'type': 'line',
                        'source': 'rectrack2',
                        "paint": {
                            "line-color": "#fbff12",
                            'line-width': 3
                        }
                    });
                    map.addLayer({
                        'id': 'deptharea3',
                        'type': 'line',
                        'source': 'deptharea3',
                    });

                    map.addLayer({
                        'id': 'sounding3',
                        'type': 'symbol',
                        'source': 'sounding3',
                        layout: {
                            'text-field': "{depth}",
                            'text-font': ["Open Sans Regular"]
                        }
                    });
                    map.addLayer({
                        'id': 'beacon_1',
                        'type': 'symbol',
                        'source': 'beacon_1',
                        layout: {
                            'icon-image': 'beacon-1',
                            'icon-size': 1
                        },
                        paint: {
                            'icon-color': "green"
                        }
                    });
                    map.addLayer({
                        'id': 'beacon_2',
                        'type': 'symbol',
                        'source': 'beacon_2',
                        layout: {
                            'icon-image': 'beacon-2',
                            'icon-size': 1
                        },
                        paint: {
                            'icon-color': "red"
                        }
                    });
                    map.addLayer({
                        'id': 'buoy_1',
                        'type': 'symbol',
                        'source': 'buoy_1',
                        layout: {
                            'icon-image': 'buoy-1',
                            'icon-size': 0.2
                        },
                        paint: {
                            'icon-color': "green"
                        }
                    });

                    map.addLayer({
                        'id': 'buoy_2',
                        'type': 'symbol',
                        'source': 'buoy_2',
                        layout: {
                            'icon-image': 'buoy-2',
                            'icon-size': 0.2
                        },
                        paint: {
                            'icon-color': "red"
                        }
                    });



                });



                var current = document.createElement('div');
                current.className = 'marker';
                current.id = 'current';
                current.style.backgroundImage =
                    'url(static/core/boatnav.png)';
                current.style.backgroundSize = '100%';
                current.style.width = '25px';
                current.style.height = '36px';

                var bay = document.createElement("div");
                bay.className = 'marker';
                bay.style.backgroundImage =
                    'url(static/core/houseicon.png)';
                bay.style.backgroundSize = '100%';
                bay.style.width = '30px';
                bay.style.height = '30px';

                new maplibregl.Marker(current)
                    .setLngLat({{current}})
                    .addTo(map);

                new maplibregl.Marker(bay)
                    .setLngLat({{home}})
                    .addTo(map);






            </script>


        </div>


</body>

<!-- Speedometer Chart Script-->
<script>
    Chart.defaults.global.animation.duration = 0;
    Chart.defaults.global.defaultFontSize = 18;
    Chart.defaults.global.defaultFontColor = "#ffffff";
    Chart.defaults.global.defaultFontFamily = "Roboto";


    var configSpeed = {

        "type": "gauge",
        "data": {
            "datasets": [
                {
                    "data": [],
                    "backgroundColor": [],
                    "borderWidth": 0,
                    "hoverBackgroundColor": [],
                    "hoverBorderWidth": 0
                }
            ],
            "current": 0,
        },
        "options": {
            responsive: true,
            "panel": {
                "min": 0,
                "max": 40,
                "tickInterval": 1,
                "tickColor": "#ffffff",
                "tickOuterRadius": 99,
                "tickInnerRadius": 85,
                "scales": [0, 5, 10, 15, 20, 25, 30, 35, 40],
                "scaleColor": "#ffffff",
                "scaleBackgroundColor": "#343a40",
                "scaleTextRadius": 70,
                "scaleTextSize": 8,
                "scaleTextColor": "#ffffff",
                "scaleOuterRadius": 99,
                "scaleInnerRadius": 85,
            },
            "needle": {
                "lengthRadius": 100,
                "circleColor": "rgba(188, 188, 188, 1)",
                "color": "red",
                "circleRadius": 7,
                "width": 5,
            },
            "cutoutPercentage": 90,
            "rotation": (1 / 2 + 1 / 3) * Math.PI,
            "circumference": 2 * Math.PI * 2 / 3,
            "legend": {
                "display": false,
                "text": "legend"
            },
            "tooltips": {
                "enabled": false
            },
            "title": {
                "display": true,
                "text": "KNTS",
                "position": "bottom",
                "titleTextColor": "rgba(255, 255, 255, 1)",
            },
            "animation": {
                "animateRotate": false,
                "animateScale": false
            },
            "hover": {
                "mode": null
            }
        }
    };


    var ctx = document.getElementById('chart-speed').getContext('2d');
    window.speed = new Chart(ctx, configSpeed);




</script>

<!-- Tide Chart Script-->
<script>
    Chart.defaults.global.defaultFontFamily = "Roboto";

    var tidedata = {
        type: 'line',
        data: {
            labels: [1, 2, 3, 4, 5, 6, 7, 8],
            datasets: [{
                data: [1, 4, 1, 4, 1, 4, 1, 4],
                backgroundColor: "rgba(255, 255, 255, 0.5)"
            }],

        },
        options: {
            legend: {
                display: false,
                text: "legend",
            },
            title: {
                display: true,
                text: "OCNJ Tide Table",
                position: "bottom",
                titleTextColor: "rgba(255, 255, 255, 1)",
                fontFamily: "Roboto",
            },
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        fontSize: 20,

                    },
                    gridLines: { color: "#ffffff" }
                }],
                xAxes: [{
                    ticks: {
                        fontSize: 15,
                    }
                }]
            },
            annotation: {
                annotations: [
                    {
                        type: "line",
                        mode: "vertical",
                        scaleID: "x-axis-0",
                        value: "0:00",
                        label: { content: "Next Tide", enabled: true, position: "middle" },
                        borderColor: "red",
                    }
                ]
            }
        }
    }
    var ctx = document.getElementById('chart-tide').getContext('2d');
    window.linechart = new Chart(ctx, tidedata);
</script>

<!-- Toggle scripts-->
<script>
    window.addEventListener("orientationchange", function (event) {
        map.resize()
    });
    document.getElementById("tide").addEventListener("click", tidetoggle);
    document.getElementById("speednav").addEventListener("click", tidetoggle);
    document.getElementById("dirnav").addEventListener("click", maptoggle);
    document.getElementById("lock").addEventListener("click", couple_toggle);
    document.getElementById("unlock").addEventListener("click", couple_toggle);
    document.getElementById("power").addEventListener("click", shutdown);
    document.getElementById("route").addEventListener("click", route_toggle);
    document.getElementById("chart-speed").addEventListener("click", speed_unit_toggle);

    function shutdown() {
        if (confirm("Shutdown BoatBuddy?")) {
            window.location.href = "{% url 'shutdown'%}";
        }
    };

    function tidetoggle() {
        var speedchart = document.getElementsByName("speedchart")[0];
        var tidechart = document.getElementsByName("tidechart")[0];
        if (speedchart.style.display === "none") {
            speedchart.style.display = "block";
            tidechart.style.display = "none";
            document.getElementById("speednav").style.display = "none";
            document.getElementById("tide").style.display = "inline";
        } else {
            speedchart.style.display = "none";
            tidechart.style.display = "block";
            document.getElementById("speednav").style.display = "inline";
            document.getElementById("tide").style.display = "none";
        }

    };
    function maptoggle() {
        var mapboxdiv = document.getElementsByName("mapboxdiv")[0];
        var speedchart = document.getElementsByName("speedchart")[0];
        var tidechart = document.getElementsByName("tidechart")[0];
        var tide_type = document.getElementById("tide_type");
        var tide_time = document.getElementById("tide_time");
        var degree = document.getElementById("degree");
        var dirarrow = document.getElementById("dirarrow");
        var direction = document.getElementById("direction");
        var heading = document.getElementById("heading");
        var speednav = document.getElementById("speednavvalue");
        var speed = document.getElementById("speed");
        map.resize();




        if (mapboxdiv.style.display === "none") {
            mapboxdiv.style.display = "block";
            tide_type.classList.add("has-text-dark");
            tide_time.classList.add("has-text-dark");
            degree.classList.add("has-text-dark");
            dirarrow.classList.add("has-text-dark");
            direction.classList.add("has-text-dark");
            heading.classList.add("has-text-dark");
            speednav.classList.add("has-text-dark");
            tide_type.classList.remove("has-text-light");
            tide_time.classList.remove("has-text-light");
            degree.classList.remove("has-text-light");
            dirarrow.classList.remove("has-text-light");
            direction.classList.remove("has-text-light");
            heading.classList.remove("has-text-light");
            speednav.classList.remove("has-text-light");
            speed.style.display = "none";
            map.resize();
        } else {
            mapboxdiv.style.display = "none";
            speed.style.display = "block";
            tide_type.classList.remove("has-text-dark");
            tide_time.classList.remove("has-text-dark");
            degree.classList.remove("has-text-dark");
            dirarrow.classList.remove("has-text-dark");
            direction.classList.remove("has-text-dark");
            heading.classList.remove("has-text-dark");
            speednav.classList.remove("has-text-dark");
            tide_type.classList.add("has-text-light");
            tide_time.classList.add("has-text-light");
            degree.classList.add("has-text-light");
            dirarrow.classList.add("has-text-light");
            direction.classList.add("has-text-light");
            heading.classList.add("has-text-light");
            speednav.classList.add("has-text-light");

        }

    };
    function couple_toggle() {
        var unlock = document.getElementById("unlock");
        var lock = document.getElementById("lock");
        if (coupled === true) {
            coupled = false;
            lock.style.display = "none";
            unlock.style.display = "inline";
        } else {
            coupled = true;
            lock.style.display = "inline";
            unlock.style.display = "none";
        }


    };
    function route_toggle() {
        var toggle = document.getElementById("route");
        if (route === true) {
            route = false;
            map.setLayoutProperty("track_history", "visibility", "none");
            toggle.style.color = "gray";
        } else {
            route = true;
            map.setLayoutProperty("track_history", "visibility", "visible");
            toggle.style.color = "red";

        }


    };
    function speed_unit_toggle() {
        if (knots) {
            knots = false;
            configSpeed.options.title.text = "MPH"
        } else {
            knots = true;
            configSpeed.options.title.text = "KNTS"

        }


    };

</script>


</html>
